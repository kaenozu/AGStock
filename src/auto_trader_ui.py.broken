import streamlit as st
import json
import os
import pandas as pd
from datetime import datetime
import time
import plotly.graph_objects as go

from src.paper_trader import PaperTrader
from fully_automated_trader import FullyAutomatedTrader

# --- Custom CSS ---
CUSTOM_CSS = """
<style>
    /* Global Theme */
    .stApp {
        background-color: #0E1117;
        color: #FAFAFA;
    }
    
    /* Metrics Cards */
    div[data-testid="stMetric"] {
        background-color: #1E2130;
        border: 1px solid #2E3440;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s;
    }
    div[data-testid="stMetric"]:hover {
        transform: translateY(-2px);
        border-color: #00D9FF;
    }
    
    /* Buttons */
    .stButton > button {
        border-radius: 20px;
        font-weight: bold;
    }
    
    /* Headers */
    h1, h2, h3 {
        font-family: 'Roboto', sans-serif;
        color: #00D9FF !important;
    }
    
    /* Tables */
    div[data-testid="stDataFrame"] {
        background-color: #1E2130;
        border-radius: 10px;
        padding: 10px;
    }
</style>
"""

import traceback

def create_auto_trader_ui():
    """ãƒ•ãƒ«ã‚ªãƒ¼ãƒˆãƒˆãƒ¬ãƒ¼ãƒ€ãƒ¼ã®ç®¡ç†ç”»é¢ã‚’ä½œæˆ"""
    st.markdown(CUSTOM_CSS, unsafe_allow_html=True)
    
    st.markdown("## ğŸš€ ãƒ•ãƒ«ã‚ªãƒ¼ãƒˆãƒ»ãƒˆãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ã‚»ãƒ³ã‚¿ãƒ¼")
    st.markdown("è‡ªå‹•å–å¼•ã‚·ã‚¹ãƒ†ãƒ ã®ç›£è¦–ã¨åˆ¶å¾¡ã‚’è¡Œã„ã¾ã™ã€‚")
    
    # è¨­å®šèª­ã¿è¾¼ã¿
    config_path = "config.json"
    config = load_config(config_path)
    
    # AI Oracle Section
    render_ai_oracle(config_path)
    
    st.divider()
    
    # 3ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
    col1, col2, col3 = st.columns([1, 1, 1])
    
    with col1:
        render_status_card(config)
    
    with col2:
        render_control_center(config, config_path)
        
    with col3:
        render_todays_summary()
    
    st.divider()
    
    # è©³ç´°è¨­å®šã€ãƒ­ã‚°ã€é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼
    tab_settings, tab_logs, tab_weekly = st.tabs(["âš™ï¸ è©³ç´°è¨­å®š (Advanced)", "ğŸ“œ å®Ÿè¡Œãƒ­ã‚°", "ğŸ“Š é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼"])
    
    with tab_settings:
        st.info("â€»é€šå¸¸ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã®ã¾ã¾ã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚")
        render_settings_form(config, config_path)
        
    with tab_logs:
        render_logs()
    
    with tab_weekly:
        render_weekly_review()

def render_ai_oracle(config_path):
    """AI Oracle (ä»Šã©ã†æ€ã†ï¼Ÿ) - Real AI Implementation"""
    with st.expander("ğŸ”® AI Oracle (ä»Šã©ã†æ€ã†ï¼Ÿ)", expanded=False):
        st.markdown("AIãŒç¾åœ¨ã®å¸‚å ´ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›¸å ´è¦³ã‚’å ã„ã¾ã™ã€‚")
        st.caption("â€» LightGBMãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€éå»ã®ä¾¡æ ¼ãƒ»å‡ºæ¥é«˜ãƒ»ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™ã‹ã‚‰ä»Šå¾Œã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’äºˆæ¸¬ã—ã¾ã™ã€‚")
        
        if st.button("ğŸ”® AIã«ç›¸å ´ã‚’èã", use_container_width=True):
            with st.spinner("æ°´æ™¶ç‰ã‚’è¦—ã„ã¦ã„ã¾ã™... (AIãƒ¢ãƒ‡ãƒ«èµ·å‹• & æ¨è«–ä¸­)"):
                try:
                    # æœ¬ç‰©ã®AIæˆ¦ç•¥ã‚’ä½¿ç”¨
                    # æœ¬ç‰©ã®AIæˆ¦ç•¥ã‚’ä½¿ç”¨
                    from src.strategies import LightGBMStrategy
                    from src.data_loader import fetch_stock_data, fetch_external_data
                    
                    # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆéŠ˜æŸ„
                    tickers = ["^N225", "^GSPC"] # æ—¥çµŒå¹³å‡ã¨S&P500
                    
                    # ãƒ‡ãƒ¼ã‚¿å–å¾— (AIã®å­¦ç¿’ã«å¿…è¦ãªæœŸé–“ã‚’å–å¾—)
                    data_map = fetch_stock_data(tickers, period="2y")
                    
                    # å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒã‚¯ãƒ­ï¼‰å–å¾—ã¨çµåˆ
                    try:
                        external_data = fetch_external_data(period="2y")
                        # å¿…è¦ãªãƒã‚¯ãƒ­æŒ‡æ¨™ã®ãƒªã‚¹ãƒˆï¼ˆLightGBMStrategyã®è¦ä»¶ã«åˆã‚ã›ã‚‹ï¼‰
                        # ã“ã“ã§ã¯ç°¡æ˜“çš„ã«çµåˆã™ã‚‹
                        macro_df = pd.DataFrame()
                        if 'US10Y' in external_data:
                            us10y = external_data['US10Y']['Close'].rename('US10Y')
                            macro_df = macro_df.join(us10y, how='outer')
                        
                        # ä»–ã®å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ã“ã“ã§è¿½åŠ 
                        
                    except Exception as e:
                        st.warning(f"ãƒã‚¯ãƒ­ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
                        macro_df = pd.DataFrame()

                    col1, col2 = st.columns(2)
                    
                    for i, ticker in enumerate(tickers):
                        df = data_map.get(ticker)
                        if df is not None and not df.empty:
                            # æœ€æ–°ä¾¡æ ¼æƒ…å ±
                            latest_close = df['Close'].iloc[-1]
                            prev_close = df['Close'].iloc[-2]
                            change = (latest_close - prev_close) / prev_close * 100
                            
                            # ãƒã‚¯ãƒ­ãƒ‡ãƒ¼ã‚¿ã‚’çµåˆ
                            if not macro_df.empty:
                                df = df.join(macro_df, how='left')
                                # æ¬ æå€¤è£œå®Œ
                                df = df.fillna(method='ffill').fillna(0)
                                
                                # ç‰¹å¾´é‡ç”Ÿæˆï¼ˆUS10Y_Retãªã©ï¼‰
                                if 'US10Y' in df.columns:
                                    df['US10Y_Ret'] = df['US10Y'].pct_change()
                                    df['US10Y_Corr'] = df['Close'].rolling(window=20).corr(df['US10Y'])
                                    df = df.fillna(0)
                            
                            # AIæ¨è«–å®Ÿè¡Œ
                            strategy = LightGBMStrategy(lookback_days=365)
                            
                            # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: generate_signalså†…ã§KeyErrorãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚
                            try:
                                signals = strategy.generate_signals(df)
                            except KeyError as e:
                                st.warning(f"ä¸€éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã«ã‚ˆã‚Šè©³ç´°åˆ†æã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ: {e}")
                                signals = pd.Series()
                            except Exception as e:
                                st.warning(f"äºˆæ¸¬ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
                                signals = pd.Series()
                            
                            if not signals.empty:
                                last_signal = signals.iloc[-1]
                                explanation = strategy.get_signal_explanation(last_signal)
                                
                                # ã‚·ã‚°ãƒŠãƒ«è§£é‡ˆ
                                if last_signal == 1:
                                    sentiment = "å¼·æ°— (Bullish) ğŸ‚"
                                    color = "green"
                                    oracle_msg = "ã€Œä¸Šæ˜‡ã®å…†ã—ãŒè¦‹ãˆã¾ã™ã€‚æ”»ã‚ã®å§¿å‹¢ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚ã€"
                                elif last_signal == -1:
                                    sentiment = "å¼±æ°— (Bearish) ğŸ»"
                                    color = "red"
                                    oracle_msg = "ã€Œä¸‹è½ã®å±é™ºãŒã‚ã‚Šã¾ã™ã€‚å®ˆã‚Šã‚’å›ºã‚ã‚‹ã¹ãã§ã™ã€‚ã€"
                                else:
                                    sentiment = "ä¸­ç«‹ (Neutral) âš–ï¸"
                                    color = "gray"
                                    oracle_msg = "ã€Œæ–¹å‘æ„ŸãŒå®šã¾ã‚Šã¾ã›ã‚“ã€‚ä»Šã¯é™è¦³ãŒè³¢æ˜ã§ã™ã€‚ã€"
                            else:
                                sentiment = "åˆ¤æ–­ä¸èƒ½ â˜ï¸"
                                color = "gray"
                                oracle_msg = "ã€Œéœ§ãŒæ¿ƒãã€æœªæ¥ãŒè¦‹é€šã›ã¾ã›ã‚“...ã€"
                                explanation = "ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ã®ãŸã‚äºˆæ¸¬ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"

                            with col1 if i == 0 else col2:
                                st.metric(
                                    f"{ticker} ã®äºˆè¨€", 
                                    f"{latest_close:,.2f}", 
                                    f"{change:+.2f}%",
                                    delta_color="normal"
                                )
                                st.markdown(f"**AIã®ç¥è¨—**: :{color}[{sentiment}]")
                                st.info(f"{oracle_msg}\n\n*æ ¹æ‹ : {explanation}*")
                    
                    st.success("AIã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸã€‚")
                    
                except Exception as e:
                    st.error(f"æ°´æ™¶ç‰ãŒå‰²ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸ...: {e}")
                    st.error(traceback.format_exc())

def load_config(path):
    if os.path.exists(path):
        try:
            with open(path, "r", encoding="utf-8") as f:
                return json.load(f)
        except:
            return {}
    return {}

def save_config(config, path):
    with open(path, "w", encoding="utf-8") as f:
        json.dump(config, f, indent=4, ensure_ascii=False)

def render_status_card(config):
    # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
    auto_enabled = config.get("auto_trading", {}).get("enabled", False)
    rakuten_enabled = config.get("rakuten", {}).get("enabled", False)
    
    st.subheader("ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹")
    
    if auto_enabled:
        st.success("âœ… è‡ªå‹•å–å¼•: æœ‰åŠ¹")
    else:
        st.warning("â¸ï¸ è‡ªå‹•å–å¼•: åœæ­¢ä¸­")
        
    if rakuten_enabled:
        st.info("æ¥½å¤©è¨¼åˆ¸é€£æº: ON")
    else:
        st.info("æ¥½å¤©è¨¼åˆ¸é€£æº: OFF (ãƒšãƒ¼ãƒ‘ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‰ã®ã¿)")
        
    # æ¬¡å›å®Ÿè¡Œäºˆå®šï¼ˆç°¡æ˜“è¡¨ç¤ºï¼‰
    st.caption("â€»ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã®è¨­å®šã«å¾“ã£ã¦å®Ÿè¡Œã•ã‚Œã¾ã™")

def render_control_center(config, config_path):
    # ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼
    st.subheader("ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼")
    
    # ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¤ãƒƒãƒ (è‡ªå‹•å–å¼•ã®æœ‰åŠ¹/ç„¡åŠ¹)
    current_status = config.get("auto_trading", {}).get("enabled", False)
    
    # ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒé¢¨ã®UI
    on = st.checkbox("ğŸ¤– è‡ªå‹•å–å¼•ã‚·ã‚¹ãƒ†ãƒ  (AI Auto-Pilot)", value=current_status)
    
    if on != current_status:
        if "auto_trading" not in config: config["auto_trading"] = {}
        config["auto_trading"]["enabled"] = on
        save_config(config, config_path)
        if on:
            st.success("AIè‡ªå‹•å–å¼•ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•ã—ã¾ã—ãŸã€‚")
        else:
            st.warning("AIè‡ªå‹•å–å¼•ã‚·ã‚¹ãƒ†ãƒ ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚")
                    st.write("æ—¥æ¬¡ãƒ«ãƒ¼ãƒãƒ³ã‚’å®Ÿè¡Œä¸­...")
                    trader.daily_routine(force_run=True)
                    
                    status.update(label="âœ… å®Ÿè¡Œå®Œäº†", state="complete", expanded=False)
                    st.success("ãƒ—ãƒ­ã‚»ã‚¹å®Œäº†")
                    time.sleep(2)
                    st.rerun()
                except Exception as e:
                    status.update(label="âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ", state="error")
                    st.error(f"ã‚¨ãƒ©ãƒ¼: {e}")

        if st.button("ğŸ›‘ ç·Šæ€¥åœæ­¢ (Emergency Stop)", type="primary", use_container_width=True):
            if "auto_trading" not in config: config["auto_trading"] = {}
            config["auto_trading"]["enabled"] = False
            save_config(config, config_path)
            st.error("ç·Šæ€¥åœæ­¢ã—ã¾ã—ãŸï¼")
            time.sleep(1)
            st.rerun()

def render_todays_summary():
    # æœ¬æ—¥ã®ã‚µãƒãƒªãƒ¼
    st.subheader("æœ¬æ—¥ã®å®Ÿç¸¾")
    
    pt = PaperTrader()
    history = pt.get_trade_history()
    
    if history.empty:
        st.info("å–å¼•ãƒ‡ãƒ¼ã‚¿ãªã—")
        return

    # timestampã‚’datetimeã«å¤‰æ›
    if 'timestamp' in history.columns:
        if not pd.api.types.is_datetime64_any_dtype(history['timestamp']):
            history['timestamp'] = pd.to_datetime(history['timestamp'])
            
        today = datetime.now().date()
        today_trades = history[history['timestamp'].dt.date == today]
    else:
        today_trades = pd.DataFrame()
    
    if today_trades.empty:
        st.info("æœ¬æ—¥ã®å–å¼•ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“")
    else:
        buy_count = len(today_trades[today_trades['action'] == 'BUY'])
        sell_count = len(today_trades[today_trades['action'] == 'SELL'])
        pnl = today_trades['realized_pnl'].sum() if 'realized_pnl' in today_trades.columns else 0
        
        col_a, col_b = st.columns(2)
        col_a.metric("ç´„å®šå›æ•°", f"{len(today_trades)}å›", f"è²·{buy_count}/å£²{sell_count}")
        col_b.metric("ç¢ºå®šæç›Š", f"Â¥{pnl:,.0f}", delta_color="normal")
        
        with st.expander("å–å¼•è©³ç´°"):
            st.dataframe(today_trades[['timestamp', 'ticker', 'action', 'quantity', 'price']], hide_index=True)

def render_settings_form(config, config_path):
    # è¨­å®šãƒ•ã‚©ãƒ¼ãƒ 
    st.markdown("### è‡ªå‹•å–å¼•ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿")
    
    with st.form("auto_trade_settings"):
        auto_enabled = st.checkbox("è‡ªå‹•å–å¼•ã‚’æœ‰åŠ¹ã«ã™ã‚‹", value=config.get("auto_trading", {}).get("enabled", True))
        
        col1, col2 = st.columns(2)
        with col1:
            max_trades = st.number_input("1æ—¥ã®æœ€å¤§å–å¼•æ•°", value=config.get("auto_trading", {}).get("max_daily_trades", 5), min_value=1, max_value=20)
            daily_loss = st.number_input("æ—¥æ¬¡æå¤±è¨±å®¹ç‡ (%)", value=abs(config.get("auto_trading", {}).get("daily_loss_limit_pct", -5.0)), min_value=1.0, max_value=20.0)
        
        with col2:
            max_vix = st.number_input("æœ€å¤§VIXï¼ˆã“ã‚Œã‚’è¶…ãˆãŸã‚‰åœæ­¢ï¼‰", value=config.get("auto_trading", {}).get("max_vix", 40.0), min_value=10.0, max_value=100.0)
            risk_per_trade = st.number_input("1ãƒˆãƒ¬ãƒ¼ãƒ‰ã®ãƒªã‚¹ã‚¯ (%)", value=config.get("auto_trading", {}).get("risk_per_trade", 0.02) * 100, min_value=0.1, max_value=10.0)
            
        st.markdown("### æ¥½å¤©è¨¼åˆ¸é€£æº")
        rakuten_enabled = st.checkbox("æ¥½å¤©è¨¼åˆ¸ã§ã®å®Ÿå–å¼•ã‚’æœ‰åŠ¹ã«ã™ã‚‹", value=config.get("rakuten", {}).get("enabled", False))
        rakuten_headless = st.checkbox("ãƒ–ãƒ©ã‚¦ã‚¶ã‚’è¡¨ç¤ºã—ãªã„ (Headless)", value=config.get("rakuten", {}).get("headless", False))
        
        st.caption("â€»ãƒ­ã‚°ã‚¤ãƒ³IDã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ç›´æ¥ config.json ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ï¼‰")
        
        if st.form_submit_button("è¨­å®šã‚’ä¿å­˜"):
            if "auto_trading" not in config: config["auto_trading"] = {}
            if "rakuten" not in config: config["rakuten"] = {}
            
            config["auto_trading"]["enabled"] = auto_enabled
            config["auto_trading"]["max_daily_trades"] = max_trades
            config["auto_trading"]["daily_loss_limit_pct"] = -daily_loss
            config["auto_trading"]["max_vix"] = max_vix
            config["auto_trading"]["risk_per_trade"] = risk_per_trade / 100
            
            config["rakuten"]["enabled"] = rakuten_enabled
            config["rakuten"]["headless"] = rakuten_headless
            
            save_config(config, config_path)
            st.success("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ")
            time.sleep(1)
            st.rerun()

def render_logs():
    # ãƒ­ã‚°è¡¨ç¤º
    log_file = "logs/auto_trader.log"
    if os.path.exists(log_file):
        with open(log_file, "r", encoding="utf-8") as f:
            logs = f.readlines()
            
        # æœ€æ–°ã®ãƒ­ã‚°ã‚’ä¸Šã«
        logs.reverse()
        
        # ãƒ­ã‚°ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        filter_text = st.text_input("ãƒ­ã‚°æ¤œç´¢", "")
        if filter_text:
            logs = [l for l in logs if filter_text.lower() in l.lower()]
            
    with col1:
        days_back = st.selectbox("è¡¨ç¤ºæœŸé–“", [7, 14, 30], index=0, format_func=lambda x: f"éå»{x}æ—¥é–“")
    with col2:
        if st.button("ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°", use_container_width=True):
            st.rerun()
    
    pt = PaperTrader()
    
    # æœŸé–“è¨­å®š
    end_date = datetime.now()
    start_date = end_date - timedelta(days=days_back)
    
    # 1. è³‡ç”£ã‚µãƒãƒªãƒ¼
    st.markdown("#### ğŸ’° è³‡ç”£çŠ¶æ³")
    balance = pt.get_current_balance()
    initial_capital = pt.initial_capital
    
    col1, col2, col3, col4 = st.columns(4)
    col1.metric("ç·è³‡ç”£", f"Â¥{balance['total_equity']:,.0f}", 
                f"{((balance['total_equity'] - initial_capital) / initial_capital * 100):.2f}%")
    col2.metric("ç¾é‡‘", f"Â¥{balance['cash']:,.0f}")
    col3.metric("æŠ•è³‡é¡", f"Â¥{balance['invested_amount']:,.0f}")
    col4.metric("å«ã¿æç›Š", f"Â¥{balance['unrealized_pnl']:,.0f}",
                f"{(balance['unrealized_pnl'] / balance['invested_amount'] * 100) if balance['invested_amount'] > 0 else 0:.2f}%")
    
    st.divider()
    
    # 2. å–å¼•ã‚µãƒãƒªãƒ¼
    st.markdown(f"#### ğŸ“ å–å¼•ã‚µãƒãƒªãƒ¼ï¼ˆéå»{days_back}æ—¥é–“ï¼‰")
    history = pt.get_trade_history()
    
    if not history.empty:
        # æ—¥æ™‚ã‚«ãƒ©ãƒ ã®å‡¦ç†
        time_col = None
        if 'timestamp' in history.columns:
            time_col = 'timestamp'
            history['timestamp'] = pd.to_datetime(history['timestamp'])
        elif 'date' in history.columns:
            time_col = 'date'
            history['date'] = pd.to_datetime(history['date'])
        
        if time_col:
            period_trades = history[history[time_col] >= start_date]
        else:
            period_trades = history
        
        if not period_trades.empty:
            col1, col2, col3 = st.columns(3)
            
            buy_count = len(period_trades[period_trades['action'] == 'BUY'])
            sell_count = len(period_trades[period_trades['action'] == 'SELL'])
            
            col1.metric("å–å¼•å›æ•°", f"{len(period_trades)}å›")
            col2.metric("è²·ã„", f"{buy_count}å›", delta_color="off")
            col3.metric("å£²ã‚Š", f"{sell_count}å›", delta_color="off")
            
            if 'realized_pnl' in period_trades.columns:
                total_pnl = period_trades['realized_pnl'].sum()
                st.metric("ç¢ºå®šæç›Š", f"Â¥{total_pnl:,.0f}", f"{total_pnl:+,.0f}")
            
            with st.expander("ğŸ“‹ å–å¼•å±¥æ­´è©³ç´°"):
                display_cols = ['ticker', 'action', 'quantity', 'price']
                if time_col:
                    display_cols = [time_col] + display_cols
                if 'realized_pnl' in period_trades.columns:
                    display_cols.append('realized_pnl')
                if 'reason' in period_trades.columns:
                    display_cols.append('reason')
                
                st.dataframe(period_trades[display_cols].sort_values(time_col if time_col else 'ticker', ascending=False), 
                           hide_index=True, use_container_width=True)
        else:
            st.info(f"éå»{days_back}æ—¥é–“ã®å–å¼•ã¯ã‚ã‚Šã¾ã›ã‚“")
    else:
        st.info("å–å¼•å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“")
    
    st.divider()
    
    # 3. éŠ˜æŸ„åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
    st.markdown("#### ğŸ† éŠ˜æŸ„åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆç¾åœ¨ä¿æœ‰ï¼‰")
    positions = pt.get_positions()
    
    if not positions.empty:
        # ã‚½ãƒ¼ãƒˆ
        positions_sorted = positions.sort_values('unrealized_pnl', ascending=False)
        
        # è‰²åˆ†ã‘è¡¨ç¤º
        def color_pnl(val):
            if val > 0:
                return 'background-color: rgba(0, 255, 0, 0.1)'
            elif val < 0:
                return 'background-color: rgba(255, 0, 0, 0.1)'
            return ''
        
        display_df = positions_sorted[['ticker', 'quantity', 'entry_price', 'current_price', 'unrealized_pnl', 'unrealized_pnl_pct']].copy()
        display_df.columns = ['éŠ˜æŸ„', 'æ•°é‡', 'å–å¾—å˜ä¾¡', 'ç¾åœ¨å€¤', 'å«ã¿æç›Š', 'æç›Šç‡(%)']
        
        styled_df = display_df.style.applymap(color_pnl, subset=['å«ã¿æç›Š'])
        st.dataframe(styled_df, hide_index=True, use_container_width=True)
        
        # ã‚µãƒãƒªãƒ¼çµ±è¨ˆ
        col1, col2, col3 = st.columns(3)
        winners = len(positions[positions['unrealized_pnl'] > 0])
        losers = len(positions[positions['unrealized_pnl'] < 0])
        col1.metric("ä¿æœ‰éŠ˜æŸ„æ•°", f"{len(positions)}éŠ˜æŸ„")
        col2.metric("ãƒ—ãƒ©ã‚¹", f"{winners}éŠ˜æŸ„", delta_color="off")
        col3.metric("ãƒã‚¤ãƒŠã‚¹", f"{losers}éŠ˜æŸ„", delta_color="off")
    else:
        st.info("ç¾åœ¨ãƒã‚¸ã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“")
    
    st.divider()
    
    # 4. è³‡ç”£æ¨ç§»ã‚°ãƒ©ãƒ•
    st.markdown("#### ğŸ“ˆ è³‡ç”£æ¨ç§»")
    equity_history = pt.get_equity_history()
    
    if not equity_history.empty:
        equity_history['date'] = pd.to_datetime(equity_history['date'])
        recent = equity_history[equity_history['date'] >= start_date]
        
        if not recent.empty:
            
            fig = go.Figure()
            fig.add_trace(go.Scatter(
                x=recent['date'],
                y=recent['total_equity'],
                mode='lines+markers',
                name='ç·è³‡ç”£',
                line=dict(color='#00D9FF', width=3),
                fill='tozeroy',
                fillcolor='rgba(0, 217, 255, 0.1)'
            ))
            
            # åˆæœŸè³‡æœ¬ã®ãƒ©ã‚¤ãƒ³
            fig.add_hline(y=initial_capital, line_dash="dash", line_color="gray", 
                         annotation_text="åˆæœŸè³‡æœ¬", annotation_position="right")
            
            fig.update_layout(
                title=f"è³‡ç”£æ¨ç§»ï¼ˆéå»{days_back}æ—¥é–“ï¼‰",
                xaxis_title="æ—¥ä»˜",
                yaxis_title="ç·è³‡ç”£ï¼ˆå††ï¼‰",
                height=400,
                hovermode='x unified',
                template='plotly_dark', # ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                paper_bgcolor='rgba(0,0,0,0)',
                plot_bgcolor='rgba(0,0,0,0)'
            )
            
            st.plotly_chart(fig, use_container_width=True)
        else:
            st.info("è¡¨ç¤ºã§ãã‚‹æœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“")
    else:
        st.info("è³‡ç”£å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“")
