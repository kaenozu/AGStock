import re
import time
import os
import pandas as pd
import plotly.graph_objects as go
import streamlit as st
from datetime import datetime

from src.constants import TICKER_NAMES
from src.paper_trader import PaperTrader
from src.enhanced_ensemble_predictor import EnhancedEnsemblePredictor
from src.utils.currency import format_currency_jp as format_currency
from src.trading.runner import run_daily_routine

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(page_title="AGStock", page_icon="ğŸ’°", layout="wide", initial_sidebar_state="collapsed")

# ã‚«ã‚¹ã‚¿ãƒ CSS - è¶…ã‚·ãƒ³ãƒ—ãƒ«
st.markdown(
    """
<style>
    /* å…¨ä½“ */
    .main {
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    /* å¤§ããªæ•°å­— */
    .big-number {
        font-size: 3rem;
        font-weight: bold;
        margin: 1rem 0;
    }
    
    .positive {
        color: #10b981;
    }
    
    .negative {
        color: #ef4444;
    }
    
    /* ã‚«ãƒ¼ãƒ‰ */
    .card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        color: #1f2937;
    }
    
    /* ä¿æœ‰éŠ˜æŸ„ */
    .stock-item {
        padding: 1rem;
        margin: 0.5rem 0;
        border-radius: 8px;
        border-left: 4px solid;
        color: #1f2937;
    }
    
    .stock-profit {
        border-left-color: #10b981;
        background: #f0fdf4;
    }
    
    .stock-loss {
        border-left-color: #ef4444;
        background: #fef2f2;
    }
    
    /* ãƒœã‚¿ãƒ³ */
    .stButton > button {
        width: 100%;
        padding: 0.75rem;
        font-size: 1.1rem;
        border-radius: 8px;
    }
    
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
    .status-ok {
        color: #10b981;
        font-size: 1.2rem;
    }
    
    .status-warning {
        color: #f59e0b;
        font-size: 1.2rem;
    }
</style>
""",
    unsafe_allow_html=True,
)


def show_main_dashboard():
    """ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰"""
    pt = PaperTrader()
    balance = pt.get_current_balance()
    positions = pt.get_positions()

    # ãƒ˜ãƒƒãƒ€ãƒ¼: ç·è³‡ç”£
    total_equity = balance["total_equity"]
    initial_capital = pt.initial_capital
    total_pnl = total_equity - initial_capital
    total_pnl_pct = (total_pnl / initial_capital) * 100 if initial_capital > 0 else 0

    st.title("ğŸ’° AGStock")

    # å¤§ããç·è³‡ç”£ã‚’è¡¨ç¤º
    color_class = "positive" if total_pnl >= 0 else "negative"
    emoji = "ğŸ“ˆ" if total_pnl >= 0 else "ğŸ“‰"

    st.markdown(
        f"""
    <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; color: white; margin-bottom: 2rem;">
        <div style="font-size: 1.2rem; opacity: 0.9;">ã‚ãªãŸã®è³‡ç”£</div>
        <div class="big-number">{format_currency(total_equity)}</div>
        <div style="font-size: 1.5rem; margin-top: 1rem;">
            <span class="{color_class}">
                {format_currency(total_pnl, show_sign=True)} ({total_pnl_pct:+.1f}%) {emoji}
            </span>
        </div>
    </div>
    """,
        unsafe_allow_html=True,
    )

    # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    st.markdown("### ğŸ¯ ä»Šæ—¥ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹")

    col1, col2, col3 = st.columns(3)

    with col1:
        st.markdown('<div class="status-ok">âœ… ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸ç¨¼åƒä¸­</div>', unsafe_allow_html=True)

    with col2:
        now = datetime.now()
        if now.weekday() < 5:  # å¹³æ—¥
            st.markdown('<div class="status-ok">â° æ¬¡å›å–å¼•: ä»Šæ—¥ 15:30</div>', unsafe_allow_html=True)
        else:
            st.markdown('<div class="status-warning">â° æ¬¡å›å–å¼•: æœˆæ›œ 15:30</div>', unsafe_allow_html=True)

    with col3:
        num_positions = len(positions)
        st.markdown(f'<div class="status-ok">ğŸ“Š ä¿æœ‰éŠ˜æŸ„: {num_positions}ä»¶</div>', unsafe_allow_html=True)

    st.markdown("---")

    # æœ¬æ—¥ã®å–å¼•çŠ¶æ³
    st.markdown("### ğŸ“Š æœ¬æ—¥ã®å–å¼•çŠ¶æ³")

    from datetime import datetime as dt

    history = pt.get_trade_history()

    today_trades_exist = False

    if not history.empty and "timestamp" in history.columns:
        # ä»Šæ—¥ã®å–å¼•ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        try:
            history["timestamp"] = pd.to_datetime(history["timestamp"])
            today = dt.now().date()
            today_trades = history[history["timestamp"].dt.date == today]

            if not today_trades.empty:
                today_trades_exist = True
                buy_count = len(today_trades[today_trades["action"] == "BUY"])
                sell_count = len(today_trades[today_trades["action"] == "SELL"])

                col1, col2, col3 = st.columns(3)

                with col1:
                    st.markdown(
                        f"""
                    <div class="card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                        <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem;">âœ… æœ¬æ—¥ã®å–å¼•</div>
                        <div style="font-size: 2rem; font-weight: bold;">{len(today_trades)}ä»¶</div>
                        <div style="font-size: 1rem; margin-top: 0.3rem;">è²·ã„: {buy_count}ä»¶ | å£²ã‚Š: {sell_count}ä»¶</div>
                    </div>
                    """,
                        unsafe_allow_html=True,
                    )

                with col2:
                    latest = today_trades.iloc[-1]
                    company_name = TICKER_NAMES.get(latest["ticker"], latest["ticker"])
                    action_emoji = "ğŸŸ¢" if latest["action"] == "BUY" else "ğŸ”´"

                    st.markdown(
                        f"""
                    <div class="card">
                        <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem;">æœ€æ–°ã®å–å¼•</div>
                        <div style="font-size: 1.3rem; font-weight: bold;">{action_emoji} {company_name}</div>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 0.3rem;">{latest['timestamp'].strftime('%H:%M')} | {latest['quantity']}æ ª</div>
                    </div>
                    """,
                        unsafe_allow_html=True,
                    )

                with col3:
                    daily_pnl = 0
                    if "realized_pnl" in today_trades.columns:
                        daily_pnl = today_trades["realized_pnl"].sum()

                    pnl_color = "#10b981" if daily_pnl >= 0 else "#ef4444"
                    pnl_emoji = "ğŸ“ˆ" if daily_pnl >= 0 else "ğŸ“‰"

                    st.markdown(
                        f"""
                    <div class="card">
                        <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem;">æœ¬æ—¥ã®æç›Š</div>
                        <div style="font-size: 2rem; font-weight: bold; color: {pnl_color};">{format_currency(daily_pnl, show_sign=True)}</div>
                        <div style="font-size: 1.3rem; margin-top: 0.3rem;">{pnl_emoji}</div>
                    </div>
                    """,
                        unsafe_allow_html=True,
                    )
        except Exception as e:
            st.error(f"å–å¼•å±¥æ­´ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

    if not today_trades_exist:
        signal_count = 0
        last_run_time = "ä¸æ˜"

        if os.path.exists("logs/auto_trader.log"):
            try:
                with open("logs/auto_trader.log", "r", encoding="utf-8", errors="ignore") as f:
                    lines = f.readlines()
                    for line in reversed(lines[-100:]):
                        if "æ¤œå‡ºã‚·ã‚°ãƒŠãƒ«æ•°:" in line or "signal" in line.lower():
                            match = re.search(r"(\d+)", line)
                            if match:
                                signal_count = int(match.group(1))
                                break
                        if "è‡ªå‹•ãƒˆãƒ¬ãƒ¼ãƒ€ãƒ¼" in line and "çµ‚äº†" in line:
                            time_match = re.search(r"\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\]", line)
                            if time_match:
                                last_run_time = time_match.group(1)
            except Exception:
                pass

        st.markdown(
            f"""
        <div class="card" style="background: #fef3c7; border-left: 4px solid #f59e0b;">
            <div style="font-size: 1.3rem; font-weight: bold; color: #92400e; margin-bottom: 0.5rem;">ğŸ“… æœ¬æ—¥ã®å–å¼•: ãªã—</div>
            <div style="color: #78350f; font-size: 1rem; line-height: 1.6;">
                <strong>ç†ç”±:</strong> å¸‚å ´ã‚¹ã‚­ãƒ£ãƒ³ã®çµæœã€è²·ã„ã‚·ã‚°ãƒŠãƒ«ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸï¼ˆæ¤œå‡ºæ•°: {signal_count}ä»¶ï¼‰<br>
                <strong>æœ€çµ‚å®Ÿè¡Œ:</strong> {last_run_time}<br>
                <strong>æ¬¡å›å®Ÿè¡Œ:</strong> æ˜æ—¥ 15:30ï¼ˆå¸‚å ´çµ‚äº†å¾Œï¼‰
            </div>
            <div style="margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 6px; color: #1f2937;">
                ğŸ’¡ <strong>è£œè¶³:</strong> AIãŒå…¨éŠ˜æŸ„ã‚’åˆ†æã—ãŸçµæœã€ç¾åœ¨ã®å¸‚å ´çŠ¶æ³ã§ã¯ã€Œè²·ã„ã€ã¨åˆ¤æ–­ã§ãã‚‹éŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
            </div>
        </div>
        """,
            unsafe_allow_html=True,
        )

    st.markdown("---")

    st.markdown("### ğŸ’¼ è³‡ç”£é…åˆ†")

    if not positions.empty:
        stock_value = (positions["quantity"] * positions["current_price"]).sum()
    else:
        stock_value = 0

    cash_value = balance["cash"]
    total = balance["total_equity"]

    stock_pct = (stock_value / total * 100) if total > 0 else 0
    cash_pct = (cash_value / total * 100) if total > 0 else 0

    col1, col2 = st.columns(2)

    with col1:
        st.markdown(
            f"""
        <div class="card">
            <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem;">ğŸ’µ ç¾é‡‘</div>
            <div style="font-size: 2rem; font-weight: bold; color: #3b82f6;">{format_currency(cash_value)}</div>
            <div style="font-size: 1.2rem; color: #666; margin-top: 0.3rem;">{cash_pct:.1f}%</div>
        </div>
        """,
            unsafe_allow_html=True,
        )

    with col2:
        st.markdown(
            f"""
        <div class="card">
            <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem;">ğŸ“Š æ ªå¼</div>
            <div style="font-size: 2rem; font-weight: bold; color: #8b5cf6;">{format_currency(stock_value)}</div>
            <div style="font-size: 1.2rem; color: #666; margin-top: 0.3rem;">{stock_pct:.1f}%</div>
        </div>
        """,
            unsafe_allow_html=True,
        )

    if total > 0:
        fig = go.Figure(
            data=[
                go.Pie(
                    labels=["ç¾é‡‘", "æ ªå¼"],
                    values=[cash_value, stock_value],
                    hole=0.4,
                    marker=dict(colors=["#3b82f6", "#8b5cf6"]),
                    textinfo="label+percent",
                    textfont=dict(size=14),
                )
            ]
        )

        fig.update_layout(showlegend=False, height=250, margin=dict(l=20, r=20, t=20, b=20))
        st.plotly_chart(fig, use_container_width=True)

    st.markdown("---")

    st.markdown("### ğŸ’¼ ä¿æœ‰éŠ˜æŸ„")

    if positions.empty:
        st.info("ã¾ã éŠ˜æŸ„ã‚’ä¿æœ‰ã—ã¦ã„ã¾ã›ã‚“ã€‚æ¬¡å›ã®è‡ªå‹•å–å¼•ï¼ˆ15:30ï¼‰ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚")
    else:
        for idx, pos in positions.iterrows():
            ticker = pos.get("ticker", idx)
            quantity = pos.get("quantity", 0)
            unrealized_pnl = pos.get("unrealized_pnl", 0)
            unrealized_pnl_pct = pos.get("unrealized_pnl_pct", 0)
            current_price = pos.get("current_price", 0)
            entry_date = pos.get("entry_date", "")
            entry_price = pos.get("entry_price", 0)

            company_name = TICKER_NAMES.get(ticker, ticker)

            if entry_date:
                try:
                    date_obj = datetime.fromisoformat(str(entry_date))
                    formatted_date = date_obj.strftime("%Y/%m/%d")
                except Exception:
                    formatted_date = str(entry_date)
            else:
                formatted_date = "ä¸æ˜"

            card_class = "stock-profit" if unrealized_pnl >= 0 else "stock-loss"
            emoji = "ğŸŸ¢" if unrealized_pnl >= 0 else "ğŸ”´"

            col_info, col_pred = st.columns([3, 1])

            with col_info:
                st.markdown(
                    f"""
                <div class="stock-item {card_class}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 1.3rem; font-weight: bold;">{emoji} {company_name}</div>
                            <div style="color: #888; font-size: 0.9rem; margin-top: 0.2rem;">{ticker}</div>
                            <div style="color: #666; margin-top: 0.5rem;">{quantity}æ ª | ç¾åœ¨ä¾¡æ ¼: {format_currency(current_price)}</div>
                            <div style="color: #888; font-size: 0.85rem; margin-top: 0.3rem;">è³¼å…¥æ—¥: {formatted_date} | è³¼å…¥ä¾¡æ ¼: {format_currency(entry_price)}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.9rem; color: #555; margin-bottom: 0.2rem;">è©•ä¾¡æç›Š</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">
                                {format_currency(unrealized_pnl, show_sign=True)}
                            </div>
                            <div style="font-size: 1.2rem; margin-top: 0.3rem;">
                                ({unrealized_pnl_pct:+.1f}%)
                            </div>
                        </div>
                    </div>
                </div>
                """,
                    unsafe_allow_html=True,
                )

            with col_pred:
                if st.button(f"ğŸ”® æœªæ¥äºˆæ¸¬\n({ticker})", key=f"pred_{ticker}", use_container_width=True):
                    with st.spinner("AIãŒæœªæ¥ã‚’è¨ˆç®—ä¸­..."):
                        try:
                            data_map = fetch_stock_data([ticker], period="2y")
                            df = data_map.get(ticker)

                            predictor = EnhancedEnsemblePredictor()
                            result = predictor.predict_trajectory(df, days_ahead=5)

                            if "error" in result:
                                st.error(f"äºˆæ¸¬ã‚¨ãƒ©ãƒ¼: {result['error']}")
                            else:
                                trend = result["trend"]
                                peak_day = result["peak_day"]
                                peak_price = result["peak_price"]
                                change_pct = result["change_pct"]

                                trend_emoji = "ğŸ“ˆ" if trend == "UP" else "ğŸ“‰" if trend == "DOWN" else "â¡ï¸"
                                trend_text = (
                                    "ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰" if trend == "UP" else "ä¸‹è½ãƒˆãƒ¬ãƒ³ãƒ‰" if trend == "DOWN" else "æ¨ªã°ã„"
                                )

                                st.success(f"äºˆæ¸¬å®Œäº†: {ticker}")

                                st.markdown(
                                    f"""
                                <div style="background: #f0f9ff; padding: 10px; border-radius: 8px; border: 1px solid #bae6fd; font-size: 0.9rem;">
                                    <div style="font-weight: bold; color: #0369a1; margin-bottom: 5px;">ğŸ¤– AIæœªæ¥äºˆæ¸¬ (5æ—¥é–“)</div>
                                    <div>æ–¹å‘æ„Ÿ: <strong>{trend_emoji} {trend_text}</strong></div>
                                    <div>äºˆæƒ³å¤‰å‹•: <strong>{change_pct:+.1f}%</strong></div>
                                    <div style="margin-top: 5px; font-size: 0.85rem; color: #666;">
                                        ãƒ”ãƒ¼ã‚¯äºˆæƒ³: {peak_day}æ—¥å¾Œ<br>
                                        (@ {format_currency(peak_price)})
                                    </div>
                                </div>
                                """,
                                    unsafe_allow_html=True,
                                )

                        except Exception as e:
                            st.error(f"ã‚¨ãƒ©ãƒ¼: {e}")

    st.markdown("---")

    st.columns(1)
    if st.button("ğŸš€ ä»Šã™ãå–å¼•", use_container_width=True, type="primary"):
        with st.spinner("å¸‚å ´ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­..."):
            result = run_daily_routine(force_run=True)
            if result["status"] == "success":
                st.success("âœ… å–å¼•å®Œäº†ï¼ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
                st.balloons()
                time.sleep(2)
                st.experimental_rerun()
            else:
                st.error(f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {result['message']}")


show_main_dashboard()
