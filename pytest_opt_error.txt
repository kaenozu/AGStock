============================= test session starts =============================
platform win32 -- Python 3.11.0, pytest-7.4.2, pluggy-1.6.0 -- C:\Users\neoen\AppData\Local\Programs\Python\Python311\python.exe
cachedir: .pytest_cache
benchmark: 5.1.0 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: C:\gemini-desktop\AGStock
configfile: pytest.ini
plugins: anyio-4.9.0, dash-3.1.1, Faker-37.5.3, logfire-4.0.0, asyncio-0.23.7, benchmark-5.1.0, cov-4.1.0, mock-3.14.1, timeout-2.4.0, xdist-3.8.0, requests-mock-1.12.1, respx-0.22.0, typeguard-4.4.4
asyncio: mode=Mode.STRICT
collecting ... collected 6 items

tests/test_optimization_coverage.py::test_hyperparameter_optimizer_init PASSED [ 16%]
tests/test_optimization_coverage.py::test_optimize_random_forest FAILED  [ 33%]
tests/test_optimization_coverage.py::test_optimize_lightgbm FAILED       [ 50%]
tests/test_optimization_coverage.py::test_optimize_transformer_method FAILED [ 66%]
tests/test_optimization_coverage.py::test_optimize_strategy_wfo FAILED   [ 83%]
tests/test_optimization_coverage.py::test_optimize_multi_objective PASSED [100%]

================================== FAILURES ===================================
_________________________ test_optimize_random_forest _________________________

self = <MagicMock name='optuna.create_study' id='1913198071248'>

    def assert_called(self):
        """assert that the mock was called at least once
        """
        if self.call_count == 0:
            msg = ("Expected '%s' to have been called." %
                   (self._mock_name or 'mock'))
>           raise AssertionError(msg)
E           AssertionError: Expected 'create_study' to have been called.

C:\Users\neoen\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py:892: AssertionError

During handling of the above exception, another exception occurred:

mock_optuna = <MagicMock name='optuna' id='1913198027984'>
sample_df =             Close  Volume  Open  High  Low
2023-01-01    100    1000   100   120   90
2023-01-02    105    1000   100 ...7    110    1000   100   120   90
2023-02-18    115    1000   100   120   90
2023-02-19    120    1000   100   120   90

    def test_optimize_random_forest(mock_optuna, sample_df):
        """RandomForest最適化テスト"""
        with patch('builtins.open', side_effect=FileNotFoundError):
            optimizer = HyperparameterOptimizer()
    
            # add_advanced_featuresをモック
            with patch('src.optimization.add_advanced_features') as mock_features:
                mock_features.return_value = sample_df
    
                optimizer.optimize_random_forest(sample_df, n_trials=1)
    
>               mock_optuna.create_study.assert_called()
E               AssertionError: Expected 'create_study' to have been called.

tests\test_optimization_coverage.py:54: AssertionError
------------------------------ Captured log call ------------------------------
ERROR    src.optimization:optimization.py:27 Error loading model params: 
WARNING  src.optimization:optimization.py:47 Not enough data for optimization
___________________________ test_optimize_lightgbm ____________________________

self = <MagicMock name='optuna.create_study' id='1913197778128'>

    def assert_called(self):
        """assert that the mock was called at least once
        """
        if self.call_count == 0:
            msg = ("Expected '%s' to have been called." %
                   (self._mock_name or 'mock'))
>           raise AssertionError(msg)
E           AssertionError: Expected 'create_study' to have been called.

C:\Users\neoen\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py:892: AssertionError

During handling of the above exception, another exception occurred:

mock_optuna = <MagicMock name='optuna' id='1913197814992'>
sample_df =             Close  Volume  Open  High  Low
2023-01-01    100    1000   100   120   90
2023-01-02    105    1000   100 ...7    110    1000   100   120   90
2023-02-18    115    1000   100   120   90
2023-02-19    120    1000   100   120   90

    def test_optimize_lightgbm(mock_optuna, sample_df):
        """LightGBM最適化テスト"""
        with patch('builtins.open', side_effect=FileNotFoundError):
            optimizer = HyperparameterOptimizer()
    
            with patch('src.optimization.add_advanced_features') as mock_features:
                mock_features.return_value = sample_df
    
                optimizer.optimize_lightgbm(sample_df, n_trials=1)
    
>               mock_optuna.create_study.assert_called()
E               AssertionError: Expected 'create_study' to have been called.

tests\test_optimization_coverage.py:68: AssertionError
------------------------------ Captured log call ------------------------------
ERROR    src.optimization:optimization.py:27 Error loading model params:
______________________ test_optimize_transformer_method _______________________

mock_optuna = <MagicMock name='optuna' id='1913199175056'>
sample_df =             Close  Volume  Open  High  Low
2023-01-01    100    1000   100   120   90
2023-01-02    105    1000   100 ...7    110    1000   100   120   90
2023-02-18    115    1000   100   120   90
2023-02-19    120    1000   100   120   90

    def test_optimize_transformer_method(mock_optuna, sample_df):
        """HyperparameterOptimizer.optimize_transformerテスト"""
        with patch('builtins.open', side_effect=FileNotFoundError):
            optimizer = HyperparameterOptimizer()
    
            with patch('src.optimization.add_advanced_features') as mock_features:
                mock_features.return_value = sample_df
    
>               optimizer.optimize_transformer(sample_df, n_trials=1)

tests\test_optimization_coverage.py:79: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <src.optimization.HyperparameterOptimizer object at 0x000001BD737EE490>
df =             Close  Volume  Open  High  Low
2023-01-01    100    1000   100   120   90
2023-01-02    105    1000   100 ...7    110    1000   100   120   90
2023-02-18    115    1000   100   120   90
2023-02-19    120    1000   100   120   90
n_trials = 1

    def optimize_transformer(self, df: pd.DataFrame, n_trials: int = 20) -> Dict[str, Any]:
        """
        Optimizes Transformer parameters.
        """
        logger.info("Starting Transformer optimization...")
    
        # 簡易的な実装: 実際にはTransformerモデルの学習が必要だが、
        # ここではパラメータ探索の枠組みのみ実装
    
        def objective(trial):
            # 探索空間
            params = {
                'hidden_size': trial.suggest_categorical('hidden_size', [32, 64, 128]),
                'num_attention_heads': trial.suggest_categorical('num_attention_heads', [2, 4, 8]),
                'num_encoder_layers': trial.suggest_int('num_encoder_layers', 1, 3),
                'dropout': trial.suggest_float('dropout', 0.0, 0.3),
                'learning_rate': trial.suggest_float('learning_rate', 1e-4, 1e-2, log=True),
                'batch_size': trial.suggest_categorical('batch_size', [16, 32, 64])
            }
    
            # 評価スコア（ダミー）
            # 実際にはここでモデル学習を行う
            return np.random.random()
    
        study = optuna.create_study(direction='maximize')
        study.optimize(objective, n_trials=n_trials)
    
        best_params = study.best_params
        logger.info(f"Best Transformer params: {best_params}")
    
        self.best_params['transformer'] = best_params
>       self.save_params()

src\optimization.py:171: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <src.optimization.HyperparameterOptimizer object at 0x000001BD737EE490>

    def save_params(self):
        os.makedirs(os.path.dirname(self.config_path), exist_ok=True)
>       with open(self.config_path, 'w') as f:

src\optimization.py:34: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <MagicMock name='open' id='1913198146064'>
args = ('config/model_params.json', 'w'), kwargs = {}

    def __call__(self, /, *args, **kwargs):
        # can't use self in-case a function / method we are mocking uses self
        # in the signature
        self._mock_check_sig(*args, **kwargs)
        self._increment_mock_call(*args, **kwargs)
>       return self._mock_call(*args, **kwargs)

C:\Users\neoen\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py:1108: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <MagicMock name='open' id='1913198146064'>
args = ('config/model_params.json', 'w'), kwargs = {}

    def _mock_call(self, /, *args, **kwargs):
>       return self._execute_mock_call(*args, **kwargs)

C:\Users\neoen\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py:1112: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <MagicMock name='open' id='1913198146064'>
args = ('config/model_params.json', 'w'), kwargs = {}
effect = <class 'FileNotFoundError'>

    def _execute_mock_call(self, /, *args, **kwargs):
        # separate from _increment_mock_call so that awaited functions are
        # executed separately from their call, also AsyncMock overrides this method
    
        effect = self.side_effect
        if effect is not None:
            if _is_exception(effect):
>               raise effect
E               FileNotFoundError

C:\Users\neoen\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py:1167: FileNotFoundError
------------------------------ Captured log call ------------------------------
ERROR    src.optimization:optimization.py:27 Error loading model params:
_________________________ test_optimize_strategy_wfo __________________________

mock_optuna = <MagicMock name='optuna' id='1913197724176'>
sample_df =             Close  Volume  Open  High  Low
2023-01-01    100    1000   100   120   90
2023-01-02    105    1000   100 ...7    110    1000   100   120   90
2023-02-18    115    1000   100   120   90
2023-02-19    120    1000   100   120   90

    def test_optimize_strategy_wfo(mock_optuna, sample_df):
        """WFOテスト"""
        strategy_class = MagicMock()
        param_grid = {'p1': (1, 10)}
    
>       optimize_strategy_wfo(
            sample_df,
            strategy_class,
            param_grid,
            window_size=10,
            step_size=5,
            n_trials=1
        )

tests\test_optimization_coverage.py:92: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

df =             Close  Volume  Open  High  Low
2023-01-01    100    1000   100   120   90
2023-01-02    105    1000   100 ...7    110    1000   100   120   90
2023-02-18    115    1000   100   120   90
2023-02-19    120    1000   100   120   90
strategy_class = <MagicMock id='1913197587856'>, param_grid = {'p1': (1, 10)}
window_size = 10, step_size = 5, n_trials = 1

    def optimize_strategy_wfo(
        df: pd.DataFrame,
        strategy_class,
        param_grid: Dict[str, Tuple],
        window_size: int = 252,  # 1 year
        step_size: int = 63,     # 3 months
        n_trials: int = 10
    ) -> Dict[str, Any]:
        """
        Walk-Forward Optimization (WFO)
    
        データを複数のウィンドウに分割し、各ウィンドウで:
        1. 訓練期間でパラメータ最適化
        2. テスト期間でパフォーマンス測定
    
        Args:
            df: 株価データ
            strategy_class: 最適化する戦略クラス
            param_grid: パラメータの探索範囲 {'param_name': (min, max)}
            window_size: 訓練期間の長さ (日数)
            step_size: ウィンドウのステップサイズ (日数)
            n_trials: 各ウィンドウでの試行回数
    
        Returns:
            各ウィンドウの最適パラメータとパフォーマンス
        """
        logger.info("Starting Walk-Forward Optimization...")
    
        results = []
        total_len = len(df)
    
        # ウィンドウをスライド
        for start_idx in range(0, total_len - window_size - step_size, step_size):
            train_end = start_idx + window_size
            test_end = min(train_end + step_size, total_len)
    
            train_df = df.iloc[start_idx:train_end]
            test_df = df.iloc[train_end:test_end]
    
            logger.info(f"Window: train={start_idx}:{train_end}, test={train_end}:{test_end}")
    
            # Optuna で訓練期間のパラメータ最適化
            def objective(trial):
                # パラメータをサンプリング
                params = {}
                for param_name, (low, high) in param_grid.items():
                    if isinstance(low, int):
                        params[param_name] = trial.suggest_int(param_name, low, high)
                    else:
                        params[param_name] = trial.suggest_float(param_name, low, high)
    
                # 戦略を初期化
                strategy = strategy_class(**params)
    
                # シグナル生成
                signals = strategy.generate_signals(train_df)
    
                # バックテスト (簡易版)
                returns = train_df['Close'].pct_change()
                strategy_returns = signals.shift(1) * returns
                sharpe = strategy_returns.mean() / (strategy_returns.std() + 1e-6) * np.sqrt(252)
    
                return sharpe
    
            study = optuna.create_study(direction='maximize')
            study.optimize(objective, n_trials=n_trials, show_progress_bar=False)
    
            best_params = study.best_params
    
            # テスト期間でパフォーマンス測定
            test_strategy = strategy_class(**best_params)
            test_signals = test_strategy.generate_signals(test_df)
            test_returns = test_df['Close'].pct_change()
            test_strategy_returns = test_signals.shift(1) * test_returns
            test_sharpe = test_strategy_returns.mean() / (test_strategy_returns.std() + 1e-6) * np.sqrt(252)
    
            results.append({
                'window': f"{start_idx}-{test_end}",
                'best_params': best_params,
                'train_sharpe': study.best_value,
                'test_sharpe': test_sharpe
            })
    
>           logger.info(f"Best params: {best_params}, Train Sharpe: {study.best_value:.2f}, Test Sharpe: {test_sharpe:.2f}")
E           TypeError: unsupported format string passed to MagicMock.__format__

src\optimization.py:346: TypeError

---------- coverage: platform win32, python 3.11.0-final-0 -----------
Name                                     Stmts   Miss  Cover   Missing
----------------------------------------------------------------------
src\advanced_backtest.py                   101    101     0%   6-282
src\advanced_features.py                   124    124     0%   10-349
src\advanced_models.py                      41     41     0%   7-93
src\advanced_risk.py                        89     89     0%   6-234
src\agents.py                              173    173     0%   1-251
src\ai_analyst.py                           46     46     0%   5-97
src\alert_manager.py                       126    126     0%   5-270
src\alert_system.py                        125    125     0%   9-344
src\anomaly_detector.py                     90     90     0%   5-208
src\async_data_loader.py                   143    143     0%   8-328
src\auth.py                                152    152     0%   5-317
src\auto_rebalancer.py                     132    132     0%   5-278
src\auto_trader_ui.py                      107    107     0%   2-159
src\backtest_engine.py                      45     45     0%   1-86
src\backtest_visualizer.py                  81     81     0%   6-314
src\backtester.py                          232    232     0%   1-416
src\backup_manager.py                      115    115     0%   9-254
src\base.py                                120    120     0%   6-196
src\benchmark_comparator.py                 99     99     0%   6-269
src\bert_sentiment.py                       72     72     0%   7-141
src\broker.py                               42     42     0%   1-70
src\cache_config.py                          8      8     0%   1-20
src\cloud_storage.py                        79     79     0%   1-106
src\config.py                               46     46     0%   1-72
src\config_manager.py                       47     47     0%   4-93
src\constants.py                            10     10     0%   1-222
src\copy_trading.py                        149    149     0%   5-382
src\cost_optimizer.py                      125    125     0%   6-347
src\cross_validation.py                     43     43     0%   9-145
src\dashboard_utils.py                      36     36     0%   4-71
src\data_loader.py                         120    120     0%   1-224
src\data_manager.py                         84     84     0%   1-174
src\db_maintenance.py                       86     86     0%   5-144
src\design_tokens.py                        52     52     0%   7-128
src\dividend_strategy.py                    71     71     0%   6-236
src\dynamic_ensemble.py                     77     77     0%   6-154
src\dynamic_risk_manager.py                 89     89     0%   7-299
src\dynamic_risk_manager_refactored.py     121    121     0%   6-337
src\dynamic_stop.py                         52     52     0%   9-101
src\encryption.py                           74     74     0%   5-188
src\enhanced_performance_dashboard.py      144    144     0%   5-323
src\ensemble.py                             27     27     0%   1-65
src\error_handler.py                       109    109     0%   6-215
src\error_handling.py                       88     88     0%   8-301
src\execution.py                            78     78     0%   1-128
src\execution_optimizer.py                  69     69     0%   6-213
src\export_manager.py                       80     80     0%   5-175
src\factor_analyzer.py                      85     85     0%   6-269
src\features.py                            122    113     7%   11-31, 38-70, 76-113, 120-202, 208-245
src\formatters.py                           83     83     0%   5-243
src\fundamentals.py                         26     26     0%   1-50
src\hierarchical_strategy.py                42     42     0%   10-85
src\hyperparameter_tuning.py               111    111     0%   8-349
src\ibkr_broker.py                          88     88     0%   1-154
src\integrated_signals.py                   69     69     0%   7-160
src\kelly_criterion.py                      35     35     0%   12-82
src\liquidity_analyzer.py                   74     74     0%   6-233
src\live_trading.py                        151    151     0%   1-260
src\llm_analyzer.py                         69     69     0%   1-125
src\logging_config.py                       45     45     0%   4-102
src\macro_analyzer.py                       89     89     0%   6-208
src\meta_learner.py                        107    107     0%   5-264
src\metrics_collector.py                    87     87     0%   5-197
src\ml_pipeline.py                          89     89     0%   1-148
src\monitoring_dashboard.py                 96     96     0%   5-174
src\mpt_optimizer.py                       102    102     0%   6-302
src\multi_timeframe.py                      77     77     0%   10-190
src\nisa_manager.py                        115    115     0%   5-342
src\notifier.py                             81     81     0%   1-203
src\online_learning.py                     113    113     0%   7-315
src\optimization.py                        204    124    39%   25, 35-36, 51-81, 93-138, 151-162, 173, 177-260, 307-325, 349-356, 385-412, 422
src\optimizer.py                            47     47     0%   1-73
src\options_pricing.py                      89     89     0%   5-264
src\paper_trader.py                        144    144     0%   1-315
src\parallel_backtester.py                  76     76     0%   5-228
src\patterns.py                             91     91     0%   1-181
src\pdf_report_generator.py                 94     94     0%   5-187
src\performance.py                         167    167     0%   1-320
src\performance_attribution.py              95     95     0%   5-232
src\performance_metrics.py                  97     97     0%   10-213
src\performance_monitor.py                 111    111     0%   10-314
src\performance_optimizer.py               113    113     0%   11-184
src\personal_features.py                   195    195     0%   6-345
src\portfolio.py                           131    131     0%   1-243
src\portfolio_manager.py                    42     42     0%   10-81
src\portfolio_manager_refactored.py        109    109     0%   6-263
src\portfolio_optimizer.py                 111    111     0%   6-269
src\production_manager.py                  101    101     0%   11-219
src\prompts.py                               3      3     0%   5-33
src\psychological_guard.py                  84     84     0%   6-294
src\pytest_cov_optional.py                  13      5    62%   14-15, 25-33
src\rakuten_broker.py                      153    153     0%   1-259
src\realtime_alerts.py                     129    129     0%   8-309
src\realtime_data.py                        96     96     0%   8-182
src\rebalancer.py                           84     84     0%   10-246
src\recovery_manager.py                    107    107     0%   5-217
src\regime.py                              100    100     0%   1-250
src\regime_detector.py                     110    110     0%   7-352
src\rich_notifier.py                       106    106     0%   5-291
src\risk_guard.py                          102    102     0%   1-198
src\risk_limiter.py                        135    135     0%   6-225
src\rl_agent.py                             74     74     0%   1-106
src\rl_environment.py                       65     65     0%   1-145
src\sector_rotation.py                      83     83     0%   1-205
src\sentiment.py                            74     74     0%   1-173
src\simple_dashboard.py                    113    113     0%   6-257
src\smart_notifier.py                       63     63     0%   7-110
src\stacking_ensemble.py                   107    107     0%   15-293
src\strategies\__init__.py                   7      7     0%   9-43
src\strategies\base.py                      50     50     0%   7-130
src\strategies\custom\__init__.py            0      0   100%
src\strategies_legacy.py                   725    725     0%   1-1138
src\strategy_marketplace.py                134    134     0%   5-381
src\streaming_pipeline.py                   84     84     0%   7-202
src\tax_calculator.py                       82     82     0%   5-280
src\tax_report_generator.py                 85     85     0%   5-268
src\trade_explainer.py                      32     32     0%   5-99
src\trader_profile.py                      123    123     0%   5-397
src\trading_performance_monitor.py          98     98     0%   7-360
src\transformer_model.py                   107    107     0%   8-339
src\ui_advanced_analytics.py               157    157     0%   5-291
src\ui_ai_chat.py                           46     46     0%   4-76
src\ui_ai_report.py                         48     48     0%   4-80
src\ui_alerts.py                            79     79     0%   4-158
src\ui_automation.py                        77     77     0%   5-132
src\ui_components.py                       130    130     0%   5-327
src\ui_customizer.py                        82     82     0%   5-240
src\ui_export.py                            83     83     0%   4-162
src\ui_renderers.py                        560    560     0%   1-1044
src\ui_risk_dashboard.py                   118    118     0%   5-232
src\visualizer.py                           75     75     0%   2-157
src\xai.py                                  78     78     0%   8-227
----------------------------------------------------------------------
TOTAL                                    13053  12956     1%
Coverage HTML written to dir htmlcov

=========================== short test summary info ===========================
FAILED tests/test_optimization_coverage.py::test_optimize_random_forest - Ass...
FAILED tests/test_optimization_coverage.py::test_optimize_lightgbm - Assertio...
FAILED tests/test_optimization_coverage.py::test_optimize_transformer_method
FAILED tests/test_optimization_coverage.py::test_optimize_strategy_wfo - Type...
========================= 4 failed, 2 passed in 7.56s =========================
